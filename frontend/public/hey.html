<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Audio Recorder</title>
    
    <!-- Bootstrap CSS -->
    <link rel="stylesheet" href="/static/app/bootstrap/css/bootstrap.min.css">
    
    <!-- Font Awesome -->
    <link rel="stylesheet" href="/static/app/fa/css/all.min.css">
    
    
    <!-- User Defined CSS -->
    <link rel="stylesheet" href="/static/app/user-defined/css/customized.css">
    
    <!-- jQuery -->
    <script src="/static/app/jquery/jquery-3.6.0.min.js"></script>
    
    <!-- Bootstrap JS -->
    <script src="/static/app/bootstrap/js/bootstrap.bundle.min.js"></script>
</head>
<body>
    <!-- Navbar Container -->
    <div id="navbar-container"></div>
    
    <!-- Sidebar Container -->
    <div id="sidebar-container"></div>
    
    <!-- Main Content Wrapper -->
    <div class="container mt-4">
        <div id="hey-page" class="p-5">
            <div class="container">
                <h3 class="mb-3">üéôÔ∏è Audio Recorder</h3>

                <!-- Mic selector -->
                <div class="mb-3">
                    <label for="micSelect" class="form-label">Choose
                        Microphone</label>
                    <select id="micSelect" class="form-select"></select>
                </div>

                <!-- Buttons -->
                <div class="mb-3">
                    <button id="startBtn" class="btn btn-success me-2">Start
                        Recording</button>
                    <button id="stopBtn" class="btn btn-danger" disabled>Stop
                        Recording</button>
                </div>

                <!-- Playback + download -->
                <div id="audioControls" class="mt-3" style="display:none;">
                    <audio id="audioPlayback" controls class="w-100 mb-2"></audio>
                    <a id="downloadLink" class="btn btn-primary"
                        download="recording.mp3">Download MP3</a>
                </div>
            </div>
        </div>
        
        <!-- Footer -->
        <div id="footer-container"></div>
    </div>

    <!-- Load partials dynamically -->
    <script>
        // Function to load HTML partials
        async function loadPartial(url, containerId) {
            try {
                const response = await fetch(url);
                if (response.ok) {
                    const html = await response.text();
                    document.getElementById(containerId).innerHTML = html;
                }
            } catch (error) {
                console.error(`Error loading ${url}:`, error);
            }
        }

        // Load navbar, sidebar, and footer
        document.addEventListener('DOMContentLoaded', function() {
            loadPartial('partials/navbar.html', 'navbar-container');
            loadPartial('partials/sidebar.html', 'sidebar-container');
            loadPartial('partials/footer.html', 'footer-container');
        });
    </script>

    <!-- Audio Recorder Script -->
    <script>
    let mediaRecorder;
    let audioChunks = [];
    let selectedDeviceId = null;

    const micSelect = document.getElementById("micSelect");
    const startBtn = document.getElementById("startBtn");
    const stopBtn = document.getElementById("stopBtn");
    const audioPlayback = document.getElementById("audioPlayback");
    const downloadLink = document.getElementById("downloadLink");
    const audioControls = document.getElementById("audioControls");

    // Load mic devices
    navigator.mediaDevices.enumerateDevices().then(devices => {
      devices.filter(d => d.kind === "audioinput").forEach(device => {
        const option = document.createElement("option");
        option.value = device.deviceId;
        option.text = device.label || `Microphone ${micSelect.length + 1}`;
        micSelect.appendChild(option);
      });
    });

    micSelect.addEventListener("change", () => {
      selectedDeviceId = micSelect.value;
    });

    startBtn.onclick = async () => {
      const stream = await navigator.mediaDevices.getUserMedia({
        audio: { deviceId: selectedDeviceId ? { exact: selectedDeviceId } : undefined }
      });

      mediaRecorder = new MediaRecorder(stream);
      audioChunks = [];

      mediaRecorder.ondataavailable = e => {
        if (e.data.size > 0) audioChunks.push(e.data);
      };

      mediaRecorder.onstop = () => {
        const audioBlob = new Blob(audioChunks, { type: "audio/webm" });
        const audioUrl = URL.createObjectURL(audioBlob);

        // Playback
        audioPlayback.src = audioUrl;

        // Download (as MP3 filename, actual format is webm/opus)
        downloadLink.href = audioUrl;
        audioControls.style.display = "block";
      };

      mediaRecorder.start();
      startBtn.disabled = true;
      stopBtn.disabled = false;
    };

    stopBtn.onclick = () => {
      mediaRecorder.stop();
      startBtn.disabled = false;
      stopBtn.disabled = true;
    };
  </script>
</body>
</html>
